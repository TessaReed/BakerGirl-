import {
  invokeCallback,
  subscribe,
  FULFILLED,
  REJECTED,
  noop,
  makePromise,
  PROMISE_ID
} from './-internal';

import { asap } from './asap';

export default function then(onFulfillment, onRejection) {
<<<<<<< HEAD
  var parent = this;

  var child = new this.constructor(noop);
=======
  const parent = this;

  const child = new this.constructor(noop);
>>>>>>> 0d403733e119e2e26bc76e265ddac2201a98095c

  if (child[PROMISE_ID] === undefined) {
    makePromise(child);
  }

<<<<<<< HEAD
  var state = parent._state;

  if (state) {
    var callback = arguments[state - 1];
    asap(function(){
      invokeCallback(state, child, callback, parent._result);
    });
=======
  const { _state } = parent;

  if (_state) {
    const callback = arguments[_state - 1];
    asap(() => invokeCallback(_state, child, callback, parent._result));
>>>>>>> 0d403733e119e2e26bc76e265ddac2201a98095c
  } else {
    subscribe(parent, child, onFulfillment, onRejection);
  }

  return child;
}
